<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SBO Admin Panel - FAQ Management</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#667eea',
            secondary: '#764ba2',
          }
        }
      }
    }
  </script>
  <style>
    * { box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f5;
    }
    
    /* Minimal custom styles */
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .tab-btn.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }
    .modal {
      display: none;
    }
    .modal.active {
      display: flex;
    }
    .tag {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      background: linear-gradient(135deg, #667eea15, #764ba215);
      border: 1px solid #667eea40;
      color: #667eea;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
      margin: 0.125rem;
    }
    .empty-state {
      text-align: center;
      padding: 3rem 1rem !important;
      color: #999;
    }
    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }
    /* Toast notifications */
    .toast {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      background: white;
      padding: 1rem 1.5rem;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      gap: 0.75rem;
      z-index: 2000;
      animation: slideInRight 0.3s ease;
      border-left: 4px solid #4caf50;
    }
    .toast.error {
      border-left-color: #f44336;
    }
    .toast.hiding {
      animation: slideOutRight 0.3s ease;
    }
    /* Animations */
    @keyframes slideInRight {
      from { transform: translateX(400px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOutRight {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(400px); opacity: 0; }
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
    }
    ::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 4px;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <!-- Header -->
  <div class="bg-gradient-to-r from-primary to-secondary text-white shadow-lg">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 md:py-6">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div class="flex-1">
          <h1 class="text-2xl md:text-3xl lg:text-4xl font-extrabold mb-1 md:mb-2">
            üõ†Ô∏è SBO Admin Panel
          </h1>
          <p class="text-sm md:text-base opacity-90">
            Manage FAQs, view analytics, and monitor student questions
          </p>
        </div>
        <button 
          onclick="logout()" 
          class="bg-white/20 hover:bg-white/30 border-2 border-white/30 text-white px-6 py-2.5 md:py-3 rounded-lg font-semibold transition-all duration-300 hover:shadow-lg active:scale-95 whitespace-nowrap self-start sm:self-auto"
        >
          üö™ Logout
        </button>
      </div>
    </div>
  </div>

  <!-- Navigation -->
  <div class="bg-white shadow-md sticky top-0 z-40">
    <div class="max-w-7xl mx-auto">
      <nav class="flex overflow-x-auto">
        <button class="tab-btn flex-shrink-0 px-4 md:px-6 py-3 md:py-4 text-sm md:text-base font-semibold text-gray-600 border-b-3 border-transparent transition-all hover:bg-gray-50 active" data-tab="analytics">
          <span class="flex items-center gap-2">
            <span>üìä</span>
            <span class="hidden sm:inline">Analytics</span>
          </span>
        </button>
        <button class="tab-btn flex-shrink-0 px-4 md:px-6 py-3 md:py-4 text-sm md:text-base font-semibold text-gray-600 border-b-3 border-transparent transition-all hover:bg-gray-50" data-tab="faqs">
          <span class="flex items-center gap-2">
            <span>üìù</span>
            <span>Manage FAQs</span>
          </span>
        </button>
        <button class="tab-btn flex-shrink-0 px-4 md:px-6 py-3 md:py-4 text-sm md:text-base font-semibold text-gray-600 border-b-3 border-transparent transition-all hover:bg-gray-50" data-tab="unanswered">
          <span class="flex items-center gap-2">
            <span>‚ùì</span>
            <span class="hidden sm:inline">Unanswered</span>
          </span>
        </button>
      </nav>
    </div>
  </div>

  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 md:py-8">
    <!-- Analytics Tab -->
    <div id="analytics" class="tab-content active">
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 mb-6 md:mb-8">
        <div class="bg-white rounded-xl shadow-md p-4 md:p-6 hover:shadow-xl transition-shadow">
          <div class="text-2xl md:text-3xl lg:text-4xl font-bold bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent mb-2" id="total-queries">-</div>
          <div class="text-xs md:text-sm font-semibold text-gray-500 uppercase tracking-wide">Total Queries (30 days)</div>
        </div>
        <div class="bg-white rounded-xl shadow-md p-4 md:p-6 hover:shadow-xl transition-shadow">
          <div class="text-2xl md:text-3xl lg:text-4xl font-bold bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent mb-2" id="unique-users">-</div>
          <div class="text-xs md:text-sm font-semibold text-gray-500 uppercase tracking-wide">Unique Users</div>
        </div>
        <div class="bg-white rounded-xl shadow-md p-4 md:p-6 hover:shadow-xl transition-shadow">
          <div class="text-2xl md:text-3xl lg:text-4xl font-bold bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent mb-2" id="avg-score">-</div>
          <div class="text-xs md:text-sm font-semibold text-gray-500 uppercase tracking-wide">Avg Confidence</div>
        </div>
        <div class="bg-white rounded-xl shadow-md p-4 md:p-6 hover:shadow-xl transition-shadow">
          <div class="text-2xl md:text-3xl lg:text-4xl font-bold bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent mb-2" id="low-conf">-</div>
          <div class="text-xs md:text-sm font-semibold text-gray-500 uppercase tracking-wide">Low Confidence</div>
        </div>
      </div>

      <div class="bg-white rounded-xl shadow-md p-4 md:p-6 lg:p-8 mb-6 md:mb-8">
        <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-4 md:mb-6">üî• Top 20 Questions</h2>
        <div class="overflow-x-auto -mx-4 md:mx-0">
          <div class="inline-block min-w-full align-middle px-4 md:px-0">
            <table id="top-questions-table" class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-3 md:px-6 py-3 md:py-4 text-left text-xs md:text-sm font-semibold text-gray-700 uppercase tracking-wider">Question</th>
                  <th class="px-3 md:px-6 py-3 md:py-4 text-left text-xs md:text-sm font-semibold text-gray-700 uppercase tracking-wider whitespace-nowrap">Times Asked</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-xl shadow-md p-4 md:p-6 lg:p-8">
        <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-4 md:mb-6">üìà FAQ Usage</h2>
        <div class="overflow-x-auto -mx-4 md:mx-0">
          <div class="inline-block min-w-full align-middle px-4 md:px-0">
            <table id="faq-usage-table" class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-3 md:px-6 py-3 md:py-4 text-left text-xs md:text-sm font-semibold text-gray-700 uppercase tracking-wider">Category</th>
                  <th class="px-3 md:px-6 py-3 md:py-4 text-left text-xs md:text-sm font-semibold text-gray-700 uppercase tracking-wider">Question</th>
                  <th class="px-3 md:px-6 py-3 md:py-4 text-left text-xs md:text-sm font-semibold text-gray-700 uppercase tracking-wider whitespace-nowrap">Times Matched</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- FAQs Tab -->
    <div id="faqs" class="tab-content">
      <div class="bg-white rounded-xl shadow-md p-4 md:p-6 lg:p-8">
        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 mb-6 md:mb-8">
          <h2 class="text-xl md:text-2xl font-bold text-gray-800">üìù All FAQs</h2>
          <button class="bg-gradient-to-r from-primary to-secondary text-white px-4 md:px-6 py-2.5 md:py-3 rounded-lg font-semibold hover:shadow-lg transition-all active:scale-95" onclick="showAddModal()">
            <span class="text-lg md:text-xl">+</span> Add New FAQ
          </button>
        </div>
        
        <div class="mb-4 md:mb-6">
          <input type="text" id="faq-search" 
                 placeholder="üîç Search FAQs by category, question, or keywords..." 
                 class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg text-sm md:text-base focus:border-primary focus:outline-none transition-colors"
                 oninput="filterFAQs(this.value)">
        </div>
        
        <div class="overflow-x-auto -mx-4 md:mx-0">
          <div class="inline-block min-w-full align-middle px-4 md:px-0">
            <table id="faqs-table" class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-3 md:px-6 py-3 md:py-4 text-left text-xs md:text-sm font-semibold text-gray-700 uppercase tracking-wider">Category</th>
                  <th class="px-3 md:px-6 py-3 md:py-4 text-left text-xs md:text-sm font-semibold text-gray-700 uppercase tracking-wider">Question</th>
                  <th class="px-3 md:px-6 py-3 md:py-4 text-left text-xs md:text-sm font-semibold text-gray-700 uppercase tracking-wider hidden lg:table-cell">Keywords</th>
                  <th class="px-3 md:px-6 py-3 md:py-4 text-left text-xs md:text-sm font-semibold text-gray-700 uppercase tracking-wider whitespace-nowrap">Actions</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                <tr>
                  <td colspan="4" class="px-6 py-12 text-center text-gray-500">
                    <div class="text-4xl mb-2">üìã</div>
                    <p class="text-sm md:text-base">Loading FAQs...</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Unanswered Questions Tab -->
    <div id="unanswered" class="tab-content">
      <div class="bg-white rounded-xl shadow-md p-4 md:p-6 lg:p-8">
        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 mb-6 md:mb-8">
          <h2 class="text-xl md:text-2xl font-bold text-gray-800">‚ùì Unanswered Questions</h2>
          <button class="bg-gradient-to-r from-primary to-secondary text-white px-4 md:px-6 py-2.5 md:py-3 rounded-lg font-semibold hover:shadow-lg transition-all active:scale-95" onclick="refreshUnanswered()">
            üîÑ Refresh
          </button>
        </div>
        <p class="text-sm md:text-base text-gray-600 mb-4 md:mb-6">
          Questions with low confidence scores (&lt;30%) that may need new FAQs. Click "Create FAQ" to add them to the database.
        </p>
        <div class="overflow-x-auto -mx-4 md:mx-0">
          <div class="inline-block min-w-full align-middle px-4 md:px-0">
            <table id="unanswered-table" class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-3 md:px-6 py-3 md:py-4 text-left text-xs md:text-sm font-semibold text-gray-700 uppercase tracking-wider">Question</th>
                  <th class="px-3 md:px-6 py-3 md:py-4 text-left text-xs md:text-sm font-semibold text-gray-700 uppercase tracking-wider whitespace-nowrap hidden sm:table-cell">Confidence</th>
                  <th class="px-3 md:px-6 py-3 md:py-4 text-left text-xs md:text-sm font-semibold text-gray-700 uppercase tracking-wider whitespace-nowrap">Times Asked</th>
                  <th class="px-3 md:px-6 py-3 md:py-4 text-left text-xs md:text-sm font-semibold text-gray-700 uppercase tracking-wider hidden md:table-cell">Timestamp</th>
                  <th class="px-3 md:px-6 py-3 md:py-4 text-left text-xs md:text-sm font-semibold text-gray-700 uppercase tracking-wider whitespace-nowrap">Actions</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                <tr>
                  <td colspan="5" class="px-6 py-12 text-center text-gray-500">
                    <div class="text-4xl mb-2">üîç</div>
                    <p class="text-sm md:text-base">Loading unanswered questions...</p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Add/Edit FAQ Modal -->
  <div id="faq-modal" class="modal fixed inset-0 bg-black/60 backdrop-blur-sm z-50 items-center justify-center">
    <div class="bg-white rounded-2xl p-6 md:p-10 max-w-2xl w-11/12 max-h-[90vh] overflow-y-auto shadow-2xl">
      <div class="flex justify-between items-start mb-6 md:mb-8">
        <h2 id="modal-title" class="text-2xl md:text-3xl font-bold bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent">Add New FAQ</h2>
        <button onclick="closeModal()" class="text-4xl text-gray-400 hover:text-gray-600 transition-colors leading-none">&times;</button>
      </div>
      <form id="faq-form">
        <input type="hidden" id="faq-id">
        
        <div class="mb-6">
          <label class="block mb-2 font-bold text-gray-700 text-xs md:text-sm uppercase tracking-wide">üìÇ Category</label>
          <input type="text" id="category" required placeholder="e.g., Events, Contact, Services" 
                 class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-primary focus:outline-none transition-colors text-sm md:text-base">
        </div>
        
        <div class="mb-6">
          <label class="block mb-2 font-bold text-gray-700 text-xs md:text-sm uppercase tracking-wide">‚ùì Question</label>
          <input type="text" id="question" required placeholder="What do students ask?" 
                 class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-primary focus:outline-none transition-colors text-sm md:text-base">
        </div>
        
        <div class="mb-6">
          <div class="flex items-center justify-between mb-2">
            <label class="font-bold text-gray-700 text-xs md:text-sm uppercase tracking-wide">üí¨ Answer</label>
            <button type="button" onclick="generateAIAnswer()" 
                    class="text-xs px-3 py-1.5 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-full font-semibold hover:shadow-md transition-all flex items-center gap-1.5">
              <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path d="M13 7H7v6h6V7z"/><path fill-rule="evenodd" d="M7 2a1 1 0 012 0v1h2V2a1 1 0 112 0v1h2a2 2 0 012 2v2h1a1 1 0 110 2h-1v2h1a1 1 0 110 2h-1v2a2 2 0 01-2 2h-2v1a1 1 0 11-2 0v-1H9v1a1 1 0 11-2 0v-1H5a2 2 0 01-2-2v-2H2a1 1 0 110-2h1V9H2a1 1 0 010-2h1V5a2 2 0 012-2h2V2zM5 5h10v10H5V5z"/></svg>
              AI Generate
            </button>
          </div>
          <textarea id="answer" rows="6" required 
                    placeholder="Provide a clear, helpful answer..."
                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-primary focus:outline-none transition-colors text-sm md:text-base leading-relaxed resize-y"></textarea>
        </div>
        
        <div class="mb-6">
          <div class="flex items-center justify-between mb-2">
            <label class="font-bold text-gray-700 text-xs md:text-sm uppercase tracking-wide">üè∑Ô∏è Keywords (comma-separated)</label>
            <button type="button" onclick="generateAIKeywords()" 
                    class="text-xs px-3 py-1.5 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-full font-semibold hover:shadow-md transition-all flex items-center gap-1.5">
              <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path d="M13 7H7v6h6V7z"/><path fill-rule="evenodd" d="M7 2a1 1 0 012 0v1h2V2a1 1 0 112 0v1h2a2 2 0 012 2v2h1a1 1 0 110 2h-1v2h1a1 1 0 110 2h-1v2a2 2 0 01-2 2h-2v1a1 1 0 11-2 0v-1H9v1a1 1 0 11-2 0v-1H5a2 2 0 01-2-2v-2H2a1 1 0 110-2h1V9H2a1 1 0 010-2h1V5a2 2 0 012-2h2V2zM5 5h10v10H5V5z"/></svg>
              AI Generate
            </button>
          </div>
          <input type="text" id="keywords" 
                 placeholder="contact, email, reach, location"
                 class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-primary focus:outline-none transition-colors text-sm md:text-base">
          <small class="text-gray-500 text-xs md:text-sm mt-1 block">
            These help match user questions more accurately
          </small>
        </div>
        
        <div class="flex gap-3 md:gap-4 mt-8">
          <button type="submit" class="flex-1 bg-gradient-to-r from-primary to-secondary text-white px-6 py-3 rounded-lg font-semibold hover:shadow-lg transition-all active:scale-95 text-sm md:text-base">
            üíæ Save FAQ
          </button>
          <button type="button" onclick="closeModal()" 
                  class="flex-1 bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-semibold hover:bg-gray-300 transition-all active:scale-95 text-sm md:text-base">
            Cancel
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
    console.log('üöÄ Admin panel starting...');
    
    // Check if user is logged in
    if (!sessionStorage.getItem('admin_logged_in')) {
      alert('Please login first!');
      window.location.href = '/';
    }

    // Logout function
    function logout() {
      if (confirm('Are you sure you want to logout?')) {
        sessionStorage.removeItem('admin_logged_in');
        window.location.href = '/';
      }
    }

    let currentFaqs = [];

    // Toast notification system
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast ${type === 'error' ? 'error' : ''}`;
      
      const icon = type === 'error' ? '‚ùå' : '‚úÖ';
      toast.innerHTML = `
        <span style="font-size: 1.5rem;">${icon}</span>
        <span style="font-weight: 600;">${message}</span>
      `;
      
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.classList.add('hiding');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // Simple tab switching function
    function switchTab(tabName) {
      console.log('Switching to tab:', tabName);
      
      // Remove active from all buttons
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      
      // Remove active from all content
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      // Add active to clicked button
      event.target.classList.add('active');
      
      // Show selected tab
      document.getElementById(tabName).classList.add('active');
    }

    // Load analytics
    async function loadAnalytics() {
      try {
        console.log('üìä Loading analytics...');
        const res = await fetch('/api/admin/analytics');
        const data = await res.json();
        
        document.getElementById('total-queries').textContent = data.stats.total_queries || 0;
        document.getElementById('unique-users').textContent = data.stats.unique_users || 0;
        document.getElementById('avg-score').textContent = ((data.stats.avg_score || 0) * 100).toFixed(0) + '%';
        document.getElementById('low-conf').textContent = data.stats.low_confidence_queries || 0;
      
        const topQuestionsBody = document.querySelector('#top-questions-table tbody');
        topQuestionsBody.innerHTML = data.topQuestions.map(q => `
          <tr class="hover:bg-gray-50 transition-colors">
            <td class="px-3 md:px-6 py-3 md:py-4 text-xs md:text-sm text-gray-800">${q.question}</td>
            <td class="px-3 md:px-6 py-3 md:py-4 text-xs md:text-sm font-bold text-primary">${q.count}</td>
          </tr>
        `).join('');
        
        const faqUsageBody = document.querySelector('#faq-usage-table tbody');
        faqUsageBody.innerHTML = data.faqUsage.map(f => `
          <tr class="hover:bg-gray-50 transition-colors">
            <td class="px-3 md:px-6 py-3 md:py-4 text-xs md:text-sm"><span class="tag">${f.category || 'General'}</span></td>
            <td class="px-3 md:px-6 py-3 md:py-4 text-xs md:text-sm text-gray-800">${f.question}</td>
            <td class="px-3 md:px-6 py-3 md:py-4 text-xs md:text-sm font-bold text-primary">${f.times_matched}</td>
          </tr>
        `).join('');
        console.log('‚úÖ Analytics loaded');
      } catch (error) {
        console.error('‚ùå Error loading analytics:', error);
      }
    }

    // Load FAQs
    async function loadFAQs() {
      try {
        console.log('üìù Loading FAQs...');
        const res = await fetch('/api/admin/faqs');
        currentFaqs = await res.json();
        console.log('FAQs loaded:', currentFaqs.length);
        
        const tbody = document.querySelector('#faqs-table tbody');
        
        if (currentFaqs.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="4" class="empty-state">
                <div class="empty-state-icon">üì≠</div>
                <p style="font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem;">No FAQs Yet</p>
                <p style="font-size: 0.9rem; color: #999;">Click "Add New FAQ" to create your first FAQ</p>
              </td>
            </tr>
          `;
        } else {
          tbody.innerHTML = currentFaqs.map(faq => `
            <tr class="hover:bg-gray-50 transition-colors">
              <td class="px-3 md:px-6 py-3 md:py-4 text-xs md:text-sm">
                <span class="tag">${faq.category || 'General'}</span>
              </td>
              <td class="px-3 md:px-6 py-3 md:py-4 text-xs md:text-sm">
                <div class="font-semibold text-gray-800 mb-1">${faq.question}</div>
                <div class="text-xs text-gray-600 leading-relaxed hidden sm:block">
                  ${faq.answer.substring(0, 100)}${faq.answer.length > 100 ? '...' : ''}
                </div>
              </td>
              <td class="px-3 md:px-6 py-3 md:py-4 text-xs md:text-sm hidden lg:table-cell">
                ${faq.keywords.slice(0, 3).map(k => `<span class="tag">${k}</span>`).join(' ')}
                ${faq.keywords.length > 3 ? `<span class="tag">+${faq.keywords.length - 3}</span>` : ''}
              </td>
              <td class="px-3 md:px-6 py-3 md:py-4 text-xs md:text-sm whitespace-nowrap">
                <button class="bg-blue-500 hover:bg-blue-600 text-white px-2 md:px-3 py-1.5 md:py-2 rounded text-xs md:text-sm font-semibold transition-colors mr-1 mb-1" onclick="editFAQ(${faq.id})" title="Edit">
                  ‚úèÔ∏è <span class="hidden md:inline">Edit</span>
                </button>
                <button class="bg-red-500 hover:bg-red-600 text-white px-2 md:px-3 py-1.5 md:py-2 rounded text-xs md:text-sm font-semibold transition-colors mb-1" onclick="deleteFAQ(${faq.id})" title="Delete">
                  üóëÔ∏è <span class="hidden md:inline">Delete</span>
                </button>
              </td>
            </tr>
          `).join('');
        }
        console.log('‚úÖ FAQs loaded');
      } catch (error) {
        console.error('‚ùå Error loading FAQs:', error);
        const tbody = document.querySelector('#faqs-table tbody');
        tbody.innerHTML = `
          <tr>
            <td colspan="4" class="empty-state">
              <div class="empty-state-icon">‚ö†Ô∏è</div>
              <p style="color: #e74c3c;">Error loading FAQs</p>
              <p style="font-size: 0.9rem; color: #999;">${error.message}</p>
            </td>
          </tr>
        `;
      }
    }

    function filterFAQs(searchTerm) {
      const term = searchTerm.toLowerCase().trim();
      const tbody = document.querySelector('#faqs-table tbody');
      
      if (!currentFaqs || currentFaqs.length === 0) {
        return;
      }
      
      if (!term) {
        // Show all FAQs if search is empty
        tbody.innerHTML = currentFaqs.map(faq => `
          <tr class="hover:bg-gray-50 transition-colors">
            <td class="px-3 md:px-6 py-3 md:py-4 text-xs md:text-sm">
              <span class="tag">${faq.category || 'General'}</span>
            </td>
            <td class="px-3 md:px-6 py-3 md:py-4 text-xs md:text-sm">
              <div class="font-semibold text-gray-800 mb-1">${faq.question}</div>
              <div class="text-xs text-gray-600 leading-relaxed hidden sm:block">
                ${faq.answer.substring(0, 100)}${faq.answer.length > 100 ? '...' : ''}
              </div>
            </td>
            <td class="px-3 md:px-6 py-3 md:py-4 text-xs md:text-sm hidden lg:table-cell">
              ${faq.keywords.slice(0, 3).map(k => `<span class="tag">${k}</span>`).join(' ')}
              ${faq.keywords.length > 3 ? `<span class="tag">+${faq.keywords.length - 3}</span>` : ''}
            </td>
            <td class="px-3 md:px-6 py-3 md:py-4 text-xs md:text-sm whitespace-nowrap">
              <button class="bg-blue-500 hover:bg-blue-600 text-white px-2 md:px-3 py-1.5 md:py-2 rounded text-xs md:text-sm font-semibold transition-colors mr-1 mb-1" onclick="editFAQ(${faq.id})" title="Edit">
                ‚úèÔ∏è <span class="hidden md:inline">Edit</span>
              </button>
              <button class="bg-red-500 hover:bg-red-600 text-white px-2 md:px-3 py-1.5 md:py-2 rounded text-xs md:text-sm font-semibold transition-colors mb-1" onclick="deleteFAQ(${faq.id})" title="Delete">
                üóëÔ∏è <span class="hidden md:inline">Delete</span>
              </button>
            </td>
          </tr>
        `).join('');
        return;
      }
      
      // Filter FAQs by category, question, or keywords
      const filtered = currentFaqs.filter(faq => {
        const categoryMatch = (faq.category || '').toLowerCase().includes(term);
        const questionMatch = faq.question.toLowerCase().includes(term);
        const keywordsMatch = faq.keywords.some(k => k.toLowerCase().includes(term));
        return categoryMatch || questionMatch || keywordsMatch;
      });
      
      if (filtered.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="4" class="empty-state">
              <div class="empty-state-icon">üîç</div>
              <p class="text-base md:text-lg font-semibold mb-2">No FAQs Found</p>
              <p class="text-sm text-gray-500">No FAQs match "${searchTerm}"</p>
            </td>
          </tr>
        `;
      } else {
        tbody.innerHTML = filtered.map(faq => `
          <tr class="hover:bg-gray-50 transition-colors">
            <td class="px-3 md:px-6 py-3 md:py-4 text-xs md:text-sm">
              <span class="tag">${faq.category || 'General'}</span>
            </td>
            <td class="px-3 md:px-6 py-3 md:py-4 text-xs md:text-sm">
              <div class="font-semibold text-gray-800 mb-1">${faq.question}</div>
              <div class="text-xs text-gray-600 leading-relaxed hidden sm:block">
                ${faq.answer.substring(0, 100)}${faq.answer.length > 100 ? '...' : ''}
              </div>
            </td>
            <td class="px-3 md:px-6 py-3 md:py-4 text-xs md:text-sm hidden lg:table-cell">
              ${faq.keywords.slice(0, 3).map(k => `<span class="tag">${k}</span>`).join(' ')}
              ${faq.keywords.length > 3 ? `<span class="tag">+${faq.keywords.length - 3}</span>` : ''}
            </td>
            <td class="px-3 md:px-6 py-3 md:py-4 text-xs md:text-sm whitespace-nowrap">
              <button class="bg-blue-500 hover:bg-blue-600 text-white px-2 md:px-3 py-1.5 md:py-2 rounded text-xs md:text-sm font-semibold transition-colors mr-1 mb-1" onclick="editFAQ(${faq.id})" title="Edit">
                ‚úèÔ∏è <span class="hidden md:inline">Edit</span>
              </button>
              <button class="bg-red-500 hover:bg-red-600 text-white px-2 md:px-3 py-1.5 md:py-2 rounded text-xs md:text-sm font-semibold transition-colors mb-1" onclick="deleteFAQ(${faq.id})" title="Delete">
                üóëÔ∏è <span class="hidden md:inline">Delete</span>
              </button>
            </td>
          </tr>
        `).join('');
      }
    }

    function showAddModal() {
      document.getElementById('modal-title').textContent = 'Add New FAQ';
      document.getElementById('faq-form').reset();
      document.getElementById('faq-id').value = '';
      document.getElementById('faq-modal').classList.add('active');
    }

    function editFAQ(id) {
      const faq = currentFaqs.find(f => f.id === id);
      if (!faq) return;
      
      document.getElementById('modal-title').textContent = 'Edit FAQ';
      document.getElementById('faq-id').value = faq.id;
      document.getElementById('category').value = faq.category;
      document.getElementById('question').value = faq.question;
      document.getElementById('answer').value = faq.answer;
      document.getElementById('keywords').value = faq.keywords.join(', ');
      document.getElementById('faq-modal').classList.add('active');
    }

    function closeModal() {
      document.getElementById('faq-modal').classList.remove('active');
    }

    async function deleteFAQ(id) {
      if (!confirm('Are you sure you want to delete this FAQ?')) return;
      
      try {
        const res = await fetch(`/api/admin/faqs/${id}`, { method: 'DELETE' });
        if (!res.ok) throw new Error('Failed to delete FAQ');
        
        await loadFAQs();
        await loadAnalytics();
        showToast('FAQ deleted successfully');
        console.log('‚úÖ FAQ deleted successfully');
      } catch (error) {
        showToast('Error deleting FAQ: ' + error.message, 'error');
        console.error('Error deleting FAQ:', error);
      }
    }

    // Load unanswered questions
    async function loadUnanswered() {
      try {
        console.log('‚ùì Loading unanswered questions...');
        const res = await fetch('/api/admin/unanswered');
        const questions = await res.json();
        console.log('Unanswered questions loaded:', questions.length);
        
        const tbody = document.querySelector('#unanswered-table tbody');
        
        if (questions.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="5" class="empty-state">
                <div class="empty-state-icon">üéâ</div>
                <p class="text-base md:text-lg font-semibold mb-2">All Questions Answered!</p>
                <p class="text-sm text-gray-500">No low-confidence questions in the past 30 days</p>
              </td>
            </tr>
          `;
        } else {
          tbody.innerHTML = questions.map(q => `
            <tr class="hover:bg-gray-50 transition-colors">
              <td class="px-3 md:px-6 py-3 md:py-4 text-xs md:text-sm">
                <div class="font-semibold text-gray-800">${q.question}</div>
                <div class="text-xs text-gray-600 sm:hidden mt-1">
                  <span class="inline-block px-2 py-0.5 rounded text-xs ${q.score < 0.15 ? 'bg-red-100 text-red-800' : 'bg-orange-100 text-orange-800'}">${(q.score * 100).toFixed(0)}%</span>
                </div>
              </td>
              <td class="px-3 md:px-6 py-3 md:py-4 text-xs md:text-sm text-center hidden sm:table-cell">
                <span class="inline-block px-3 py-1 rounded-full text-xs font-semibold ${q.score < 0.15 ? 'bg-red-100 text-red-800' : 'bg-orange-100 text-orange-800'}">
                  ${(q.score * 100).toFixed(0)}%
                </span>
              </td>
              <td class="px-3 md:px-6 py-3 md:py-4 text-xs md:text-sm text-center font-bold text-primary">
                ${q.times_asked}
              </td>
              <td class="px-3 md:px-6 py-3 md:py-4 text-xs text-gray-600 hidden md:table-cell">
                ${new Date(q.timestamp).toLocaleString()}
              </td>
              <td class="px-3 md:px-6 py-3 md:py-4 text-xs md:text-sm whitespace-nowrap">
                <button class="bg-green-500 hover:bg-green-600 text-white px-2 md:px-3 py-1.5 md:py-2 rounded text-xs md:text-sm font-semibold transition-colors mr-1 mb-1" onclick="createFAQFromQuestion('${q.question.replace(/'/g, "\\'")}')">
                  ‚ûï <span class="hidden md:inline">Create FAQ</span>
                </button>
                <button class="bg-red-500 hover:bg-red-600 text-white px-2 md:px-3 py-1.5 md:py-2 rounded text-xs md:text-sm font-semibold transition-colors mb-1" onclick="deleteUnanswered(${q.id})">
                  üóëÔ∏è <span class="hidden md:inline">Dismiss</span>
                </button>
              </td>
            </tr>
          `).join('');
        }
        console.log('‚úÖ Unanswered questions loaded');
      } catch (error) {
        console.error('‚ùå Error loading unanswered:', error);
        const tbody = document.querySelector('#unanswered-table tbody');
        tbody.innerHTML = `
          <tr>
            <td colspan="5" class="empty-state">
              <div class="empty-state-icon">‚ö†Ô∏è</div>
              <p style="color: #e74c3c;">Error loading unanswered questions</p>
              <p style="font-size: 0.9rem; color: #999;">${error.message}</p>
            </td>
          </tr>
        `;
      }
    }

    function refreshUnanswered() {
      loadUnanswered();
    }

    function createFAQFromQuestion(question) {
      document.getElementById('modal-title').textContent = 'Create FAQ from Question';
      document.getElementById('faq-form').reset();
      document.getElementById('faq-id').value = '';
      document.getElementById('question').value = question;
      document.getElementById('faq-modal').classList.add('active');
    }

    async function deleteUnanswered(id) {
      if (!confirm('Dismiss this question? It will be removed from the unanswered list.')) return;
      
      try {
        const res = await fetch(`/api/admin/unanswered/${id}`, { method: 'DELETE' });
        if (!res.ok) throw new Error('Failed to dismiss question');
        
        await loadUnanswered();
        showToast('Question dismissed successfully');
        console.log('‚úÖ Question dismissed successfully');
      } catch (error) {
        showToast('Error dismissing question: ' + error.message, 'error');
        console.error('Error dismissing question:', error);
      }
    }

    // Make functions globally accessible for onclick attributes
    window.showAddModal = showAddModal;
    window.editFAQ = editFAQ;
    window.closeModal = closeModal;
    window.deleteFAQ = deleteFAQ;
    window.filterFAQs = filterFAQs;
    window.createFAQFromQuestion = createFAQFromQuestion;
    window.deleteUnanswered = deleteUnanswered;

    // Initialize when page loads
    window.addEventListener('load', () => {
      console.log('ÔøΩ Initializing admin panel...');

      // Tab switching - add click handlers
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const tabName = this.getAttribute('data-tab');
          console.log('Tab clicked:', tabName);
          
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          
          this.classList.add('active');
          document.getElementById(tabName).classList.add('active');
        });
      });

      // Form submit
      document.getElementById('faq-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const id = document.getElementById('faq-id').value;
        const data = {
          category: document.getElementById('category').value.trim(),
          question: document.getElementById('question').value.trim(),
          answer: document.getElementById('answer').value.trim(),
          keywords: document.getElementById('keywords').value.split(',').map(k => k.trim()).filter(Boolean)
        };
        
        // Validation
        if (!data.category || !data.question || !data.answer) {
          alert('Please fill in all required fields (Category, Question, Answer)');
          return;
        }
        
        try {
          if (id) {
            const res = await fetch(`/api/admin/faqs/${id}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(data)
            });
            if (!res.ok) throw new Error('Failed to update FAQ');
            showToast('FAQ updated successfully');
          } else {
            const res = await fetch('/api/admin/faqs', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(data)
            });
            if (!res.ok) throw new Error('Failed to create FAQ');
            showToast('FAQ created successfully');
          }
          
          closeModal();
          await loadFAQs();
          await loadAnalytics();
          await loadUnanswered();
          
          // Show success message
          console.log(`‚úÖ FAQ ${id ? 'updated' : 'created'} successfully`);
        } catch (error) {
          showToast('Error saving FAQ: ' + error.message, 'error');
          console.error('Error saving FAQ:', error);
        }
      });

      // Close modal on background click
      document.getElementById('faq-modal').addEventListener('click', (e) => {
        if (e.target.id === 'faq-modal') closeModal();
      });

      // AI-powered features
      async function generateAIAnswer() {
        const question = document.getElementById('question').value.trim();
        const category = document.getElementById('category').value.trim();
        
        if (!question) {
          alert('Please enter a question first!');
          return;
        }
        
        const answerField = document.getElementById('answer');
        const originalPlaceholder = answerField.placeholder;
        answerField.placeholder = 'ü§ñ AI is generating an answer...';
        answerField.disabled = true;
        
        try {
          const res = await fetch('/api/admin/ai/generate-answer', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ question, category: category || 'General' })
          });
          
          if (!res.ok) {
            const error = await res.json();
            throw new Error(error.error || 'Failed to generate answer');
          }
          
          const data = await res.json();
          answerField.value = data.answer;
          showToast('‚ú® AI generated an answer!');
        } catch (error) {
          console.error('AI generation error:', error);
          showToast('AI generation failed: ' + error.message, 'error');
        } finally {
          answerField.placeholder = originalPlaceholder;
          answerField.disabled = false;
          answerField.focus();
        }
      }

      async function generateAIKeywords() {
        const question = document.getElementById('question').value.trim();
        const answer = document.getElementById('answer').value.trim();
        
        if (!question || !answer) {
          alert('Please enter both question and answer first!');
          return;
        }
        
        const keywordsField = document.getElementById('keywords');
        const originalPlaceholder = keywordsField.placeholder;
        keywordsField.placeholder = 'ü§ñ AI is generating keywords...';
        keywordsField.disabled = true;
        
        try {
          const res = await fetch('/api/admin/ai/generate-keywords', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ question, answer })
          });
          
          if (!res.ok) {
            const error = await res.json();
            throw new Error(error.error || 'Failed to generate keywords');
          }
          
          const data = await res.json();
          keywordsField.value = data.keywords.join(', ');
          showToast('‚ú® AI generated keywords!');
        } catch (error) {
          console.error('AI generation error:', error);
          showToast('AI generation failed: ' + error.message, 'error');
        } finally {
          keywordsField.placeholder = originalPlaceholder;
          keywordsField.disabled = false;
          keywordsField.focus();
        }
      }

      // Make AI functions globally accessible
      window.generateAIAnswer = generateAIAnswer;
      window.generateAIKeywords = generateAIKeywords;

      // Load initial data
      loadAnalytics();
      loadFAQs();
      loadUnanswered();

      // Auto-refresh analytics every 30 seconds
      setInterval(loadAnalytics, 30000);
      
      // Check AI status
      fetch('/api/admin/ai/status')
        .then(res => res.json())
        .then(data => {
          if (data.enabled) {
            console.log(`‚úÖ AI Features enabled (${data.provider} - ${data.model})`);
          } else {
            console.log('‚ÑπÔ∏è AI Features disabled');
          }
        })
        .catch(() => console.log('‚ÑπÔ∏è Could not check AI status'));
      
      console.log('‚úÖ Admin panel ready!');
    });
  </script>
</body>
</html>
