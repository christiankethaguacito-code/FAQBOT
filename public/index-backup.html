<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SKSU SBO Chat Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }
        
        .chat-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .messages-container {
            flex: 1;
            overflow-y: auto;
            scroll-behavior: smooth;
        }
        
        .message {
            animation: fadeInUp 0.3s ease;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .typing-indicator {
            display: inline-flex;
            gap: 4px;
            padding: 12px 16px;
            background: #f3f4f6;
            border-radius: 18px;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            background: #9ca3af;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }
        
        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.7;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }
        
        .suggestion-btn {
            transition: all 0.2s ease;
        }
        
        .suggestion-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .input-container {
            border-top: 1px solid #e5e7eb;
            background: white;
        }
        
        .chat-input {
            resize: none;
            outline: none;
        }
        
        .chat-input:focus {
            border-color: #7c3aed;
        }
        
        /* Custom scrollbar */
        .messages-container::-webkit-scrollbar {
            width: 6px;
        }
        
        .messages-container::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        .messages-container::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        
        .messages-container::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        /* Admin button - subtle and elegant */
        .admin-btn {
            position: fixed;
            bottom: 100px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
            z-index: 1000;
        }
        
        .admin-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        
        .admin-btn svg {
            width: 24px;
            height: 24px;
            color: white;
        }
        
        .admin-tooltip {
            position: absolute;
            right: 60px;
            background: #1f2937;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        .admin-btn:hover .admin-tooltip {
            opacity: 1;
        }

        /* Mode Toggle Switch */
        .mode-toggle-container {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.15);
            padding: 6px 12px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }

        .toggle-switch {
            position: relative;
            width: 48px;
            height: 24px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .toggle-switch.active {
            background: rgba(255, 255, 255, 0.5);
        }

        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(24px);
        }

        .mode-label {
            font-size: 12px;
            font-weight: 500;
            color: white;
            opacity: 0.8;
            transition: opacity 0.3s ease;
        }

        .mode-label.active {
            opacity: 1;
            font-weight: 600;
        }

        .ai-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4);
            }
            50% {
                box-shadow: 0 0 0 6px rgba(16, 185, 129, 0);
            }
        }

        /* Voice buttons */
        .voice-btn {
            transition: all 0.3s ease;
        }

        .voice-btn:hover {
            transform: scale(1.05);
        }

        .voice-btn.recording {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            animation: recordingPulse 1.5s infinite;
        }

        @keyframes recordingPulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }
            50% {
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }
        }

        .voice-btn.speaking {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            animation: speakingPulse 1s infinite;
        }

        @keyframes speakingPulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }

        .speaker-icon {
            width: 20px;
            height: 20px;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Admin Button -->
    <div class="admin-btn" onclick="openAdminPanel()" title="Admin Panel">
        <span class="admin-tooltip">Admin Panel</span>
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
        </svg>
    </div>

    <!-- Chat Container -->
    <div class="chat-container">
        <!-- Header -->
        <div class="gradient-bg text-white px-4 py-4 shadow-lg">
            <div class="flex items-center justify-between max-w-4xl mx-auto">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center text-2xl">
                        üéì
                    </div>
                    <div>
                        <h1 class="text-lg font-bold flex items-center gap-2">
                            SKSU SBO Assistant
                            <span id="aiModeBadge" class="ai-badge" style="display: none;">
                                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M11 3a1 1 0 10-2 0v1a1 1 0 102 0V3zM15.657 5.757a1 1 0 00-1.414-1.414l-.707.707a1 1 0 001.414 1.414l.707-.707zM18 10a1 1 0 01-1 1h-1a1 1 0 110-2h1a1 1 0 011 1zM5.05 6.464A1 1 0 106.464 5.05l-.707-.707a1 1 0 00-1.414 1.414l.707.707zM5 10a1 1 0 01-1 1H3a1 1 0 110-2h1a1 1 0 011 1zM8 16v-1h4v1a2 2 0 11-4 0zM12 14c.015-.34.208-.646.477-.859a4 4 0 10-4.954 0c.27.213.462.519.476.859h4.002z"/>
                                </svg>
                                AI Mode
                            </span>
                        </h1>
                        <p class="text-xs text-purple-200" id="headerSubtitle">Always here to help</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <!-- Mode Toggle -->
                    <div class="mode-toggle-container">
                        <span class="mode-label active" id="faqLabel">FAQ</span>
                        <div class="toggle-switch" id="modeToggle" onclick="toggleMode()">
                            <div class="toggle-slider"></div>
                        </div>
                        <span class="mode-label" id="aiLabel">AI</span>
                    </div>
                    <!-- Reset Button -->
                    <button onclick="resetChat()" class="text-white hover:bg-white/20 p-2 rounded-lg transition">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Messages Area -->
        <div class="messages-container flex-1 px-4 py-6 bg-gray-50" id="messagesContainer">
            <div class="max-w-4xl mx-auto space-y-4" id="messagesList">
                <!-- Welcome Message -->
                <div class="message flex gap-3">
                    <div class="w-8 h-8 bg-purple-600 rounded-full flex-shrink-0 flex items-center justify-center text-white font-bold">
                        AI
                    </div>
                    <div class="flex-1">
                        <div class="bg-white rounded-2xl rounded-tl-none px-4 py-3 shadow-sm">
                            <p class="text-gray-800">Hi! üëã I'm your SKSU SBO assistant. I can help you with information about:</p>
                        </div>
                        <div id="categorySuggestions" class="mt-3 flex flex-wrap gap-2">
                            <!-- Category suggestions will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="input-container px-4 py-4">
            <div class="max-w-4xl mx-auto">
                <form onsubmit="handleSendMessage(event)" class="flex gap-3">
                    <!-- Voice Input Button -->
                    <button 
                        type="button"
                        onclick="toggleVoiceInput()"
                        class="voice-btn gradient-bg text-white p-3 rounded-2xl hover:shadow-lg transition flex-shrink-0"
                        id="voiceButton"
                        title="Voice input"
                    >
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" id="micIcon">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/>
                        </svg>
                    </button>
                    
                    <div class="flex-1 relative">
                        <textarea
                            id="userInput"
                            rows="1"
                            class="chat-input w-full px-4 py-3 pr-12 border border-gray-300 rounded-2xl resize-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            placeholder="Ask me anything about SKSU..."
                            onkeydown="handleKeyDown(event)"
                        ></textarea>
                    </div>
                    <button 
                        type="submit"
                        class="gradient-bg text-white p-3 rounded-2xl hover:shadow-lg transition flex-shrink-0 disabled:opacity-50 disabled:cursor-not-allowed"
                        id="sendButton"
                    >
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                        </svg>
                    </button>
                </form>
                <p class="text-xs text-gray-500 mt-2 text-center">
                    <span id="inputHint">Press Enter to send, Shift+Enter for new line ‚Ä¢ Click üé§ for voice input</span>
                </p>
            </div>
        </div>
    </div>

    <script>
        let categories = [];
        let currentConversation = [];
        let isAIMode = false; // Track current mode
        let aiConversationHistory = []; // Store AI conversation for context

        // Voice features
        let recognition = null;
        let isRecording = false;
        let synthesis = window.speechSynthesis;
        let currentUtterance = null;
        let voiceSettings = null; // Store voice settings from database
        let availableVoices = []; // Store browser voices

        // Initialize speech recognition
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                document.getElementById('userInput').value = transcript;
                stopRecording();
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                stopRecording();
                if (event.error === 'no-speech') {
                    alert('No speech detected. Please try again.');
                }
            };

            recognition.onend = () => {
                stopRecording();
            };
        }

        // Load categories on page load
        document.addEventListener('DOMContentLoaded', async () => {
            await loadCategories();
            await loadVoiceSettings(); // Load voice settings from database
            loadAvailableVoices(); // Load browser voices
            displayCategorySuggestions();
        });

        // Load voice settings from database
        async function loadVoiceSettings() {
            try {
                console.log('üì• Loading voice settings from database...');
                const response = await fetch('/api/voice-settings');
                console.log('üì° Response status:', response.status);
                
                const data = await response.json();
                console.log('üì¶ Response data:', data);
                
                if (data.settings) {
                    voiceSettings = data.settings;
                    console.log('‚úÖ Voice settings loaded successfully:', voiceSettings);
                    console.log(`  - Voice: ${voiceSettings.voice_name || 'default'}`);
                    console.log(`  - Language: ${voiceSettings.voice_lang}`);
                    console.log(`  - Rate: ${voiceSettings.voice_rate}x`);
                    console.log(`  - Pitch: ${voiceSettings.voice_pitch}`);
                    console.log(`  - Volume: ${voiceSettings.voice_volume}`);
                } else {
                    console.warn('‚ö†Ô∏è No settings in response, using defaults');
                    voiceSettings = {
                        voice_name: '',
                        voice_lang: 'en-US',
                        voice_rate: 1.0,
                        voice_pitch: 1.0,
                        voice_volume: 1.0
                    };
                }
            } catch (error) {
                console.error('‚ùå Error loading voice settings:', error);
                // Use default settings if loading fails
                voiceSettings = {
                    voice_name: '',
                    voice_lang: 'en-US',
                    voice_rate: 1.0,
                    voice_pitch: 1.0,
                    voice_volume: 1.0
                };
                console.log('üîÑ Using default voice settings');
            }
        }

        // Load available browser voices
        function loadAvailableVoices() {
            availableVoices = synthesis.getVoices();
            
            // Chrome loads voices asynchronously
            if (availableVoices.length === 0) {
                synthesis.onvoiceschanged = () => {
                    availableVoices = synthesis.getVoices();
                    console.log('üó£Ô∏è Available voices loaded:', availableVoices.length);
                };
            } else {
                console.log('üó£Ô∏è Available voices loaded:', availableVoices.length);
            }
        }

        // Toggle between FAQ and AI mode
        function toggleMode() {
            isAIMode = !isAIMode;
            
            const toggle = document.getElementById('modeToggle');
            const faqLabel = document.getElementById('faqLabel');
            const aiLabel = document.getElementById('aiLabel');
            const aiModeBadge = document.getElementById('aiModeBadge');
            const headerSubtitle = document.getElementById('headerSubtitle');
            
            if (isAIMode) {
                toggle.classList.add('active');
                faqLabel.classList.remove('active');
                aiLabel.classList.add('active');
                aiModeBadge.style.display = 'inline-flex';
                headerSubtitle.textContent = 'Powered by AI - Ask me anything!';
            } else {
                toggle.classList.remove('active');
                faqLabel.classList.add('active');
                aiLabel.classList.remove('active');
                aiModeBadge.style.display = 'none';
                headerSubtitle.textContent = 'Always here to help';
            }
            
            // Reset chat when switching modes
            resetChat();
        }

        async function loadCategories() {
            try {
                const response = await fetch('/api/categories');
                const data = await response.json();
                categories = data.categories;
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        function displayCategorySuggestions() {
            const container = document.getElementById('categorySuggestions');
            container.innerHTML = '';
            
            categories.forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'suggestion-btn px-4 py-2 bg-purple-100 text-purple-700 rounded-full text-sm font-medium hover:bg-purple-200';
                btn.innerHTML = `${category.icon} ${category.name}`;
                btn.onclick = () => selectCategory(category);
                container.appendChild(btn);
            });
        }

        async function selectCategory(category) {
            // Add user message
            addUserMessage(`Tell me about ${category.name}`);
            
            // Show typing indicator
            showTypingIndicator();
            
            try {
                // Fetch questions for this category
                const response = await fetch(`/api/categories/${category.id}/questions`);
                const data = await response.json();
                
                // Remove typing indicator
                removeTypingIndicator();
                
                if (data.questions.length === 0) {
                    addBotMessage(`I don't have any information about ${category.name} yet. Please try another category.`);
                    return;
                }
                
                // Show category intro
                addBotMessage(`Great! I can help you with ${category.icon} **${category.name}**. Here are some questions you can ask:`);
                
                // Show question suggestions
                addQuestionSuggestions(data.questions);
                
            } catch (error) {
                removeTypingIndicator();
                addBotMessage('Sorry, I encountered an error. Please try again.');
            }
        }

        function addQuestionSuggestions(questions) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message flex gap-3';
            messageDiv.innerHTML = `
                <div class="w-8 h-8 bg-purple-600 rounded-full flex-shrink-0 flex items-center justify-center text-white font-bold">
                    AI
                </div>
                <div class="flex-1">
                    <div class="space-y-2" id="questionButtons">
                        ${questions.map((q, index) => `
                            <button 
                                onclick='askQuestion(${JSON.stringify(q).replace(/'/g, "&apos;")})' 
                                class="suggestion-btn block w-full text-left px-4 py-3 bg-white hover:bg-purple-50 rounded-xl border border-gray-200 text-gray-700 text-sm transition"
                            >
                                <span class="font-medium text-purple-600">${index + 1}.</span> ${q.question}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
            
            document.getElementById('messagesList').appendChild(messageDiv);
            scrollToBottom();
        }

        async function askQuestion(question) {
            // Add user message
            addUserMessage(question.question);
            
            // Show typing indicator
            showTypingIndicator();
            
            // Simulate thinking delay
            await new Promise(resolve => setTimeout(resolve, 800));
            
            // Remove typing indicator
            removeTypingIndicator();
            
            // Add bot answer with image if available
            addBotMessage(question.answer, question.image_url || '');
            
            // Add follow-up options
            addFollowUpOptions();
        }

        async function handleSendMessage(event) {
            event.preventDefault();
            
            const input = document.getElementById('userInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Clear input
            input.value = '';
            input.style.height = 'auto';
            
            // Add user message
            addUserMessage(message);
            
            // Show typing indicator
            showTypingIndicator();
            
            try {
                if (isAIMode) {
                    // AI Mode - Chat with Groq AI (with automatic retry on key switch)
                    let retryCount = 0;
                    let maxRetries = 2; // Allow one retry for key switching
                    let success = false;
                    
                    while (!success && retryCount <= maxRetries) {
                        const response = await fetch('/api/ai/chat', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                message: message,
                                conversationHistory: aiConversationHistory
                            })
                        });
                        
                        const data = await response.json();
                        
                        // Check if we need to retry due to key switch
                        if (data.retry && retryCount < maxRetries) {
                            console.log(`üîÑ API key switched to #${data.switchedToKey}, retrying...`);
                            retryCount++;
                            await new Promise(resolve => setTimeout(resolve, 500)); // Small delay
                            continue;
                        }
                        
                        // Remove typing indicator
                        removeTypingIndicator();
                        
                        if (data.success && data.response) {
                            // Add AI response to conversation history
                            aiConversationHistory.push({ role: 'user', content: message });
                            aiConversationHistory.push({ role: 'assistant', content: data.response });
                            
                            // Keep only last 10 messages for context (5 exchanges)
                            if (aiConversationHistory.length > 10) {
                                aiConversationHistory = aiConversationHistory.slice(-10);
                            }
                            
                            addBotMessage(data.response);
                            
                            // Show which API key was used (optional, for debugging)
                            if (data.apiKeyUsed && data.apiKeyUsed > 1) {
                                console.log(`‚úÖ Response from API key #${data.apiKeyUsed}`);
                            }
                            success = true;
                        } else if (data.allKeysLimited) {
                            // All keys exhausted
                            addBotMessage("‚ö†Ô∏è All AI API keys have reached their daily limit. Please use FAQ mode or try again in 24 hours.");
                            success = true; // Stop retrying
                        } else {
                            addBotMessage(data.error || "I apologize, but I encountered an error. Please try again.");
                            success = true; // Stop retrying
                        }
                    }
                    
                } else {
                    // FAQ Mode - Search database
                    const response = await fetch('/api/search', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ query: message })
                    });
                    
                    const data = await response.json();
                    
                    // Remove typing indicator
                    removeTypingIndicator();
                    
                    if (data.results && data.results.length > 0) {
                        const topResult = data.results[0];
                        addBotMessage(topResult.answer, topResult.image_url || '');
                        
                        // Show related questions if available
                        if (data.results.length > 1) {
                            addRelatedQuestions(data.results.slice(1, 4));
                        }
                    } else {
                        addBotMessage("I couldn't find a specific answer to that question. Here are the topics I can help with:");
                        displayCategorySuggestions();
                    }
                    
                    // Add follow-up options
                    addFollowUpOptions();
                }
                
            } catch (error) {
                removeTypingIndicator();
                addBotMessage('Sorry, I encountered an error. Please try again.');
            }
        }

        function addRelatedQuestions(questions) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message flex gap-3';
            messageDiv.innerHTML = `
                <div class="w-8 h-8 bg-purple-600 rounded-full flex-shrink-0 flex items-center justify-center text-white font-bold">
                    AI
                </div>
                <div class="flex-1">
                    <div class="bg-purple-50 rounded-2xl rounded-tl-none px-4 py-3 border border-purple-100">
                        <p class="text-sm text-purple-900 font-medium mb-2">Related questions:</p>
                        <div class="space-y-2">
                            ${questions.map(q => `
                                <button 
                                    onclick='askQuestion(${JSON.stringify(q).replace(/'/g, "&apos;")})'
                                    class="block w-full text-left text-sm text-purple-700 hover:text-purple-900 hover:underline"
                                >
                                    ‚Ä¢ ${q.question}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('messagesList').appendChild(messageDiv);
            scrollToBottom();
        }

        function addFollowUpOptions() {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message flex gap-3';
            messageDiv.innerHTML = `
                <div class="w-8 h-8"></div>
                <div class="flex-1">
                    <div class="flex flex-wrap gap-2 mt-2">
                        <button onclick="resetChat()" class="suggestion-btn px-4 py-2 bg-gray-100 text-gray-700 rounded-full text-sm hover:bg-gray-200">
                            üè† Start Over
                        </button>
                        <button onclick="displayCategorySuggestions()" class="suggestion-btn px-4 py-2 bg-gray-100 text-gray-700 rounded-full text-sm hover:bg-gray-200">
                            üìö Browse Topics
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('messagesList').appendChild(messageDiv);
            scrollToBottom();
        }

        function addUserMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message flex gap-3 justify-end';
            messageDiv.innerHTML = `
                <div class="flex-1 flex justify-end">
                    <div class="gradient-bg text-white rounded-2xl rounded-tr-none px-4 py-3 max-w-md shadow-sm">
                        <p>${escapeHtml(message)}</p>
                    </div>
                </div>
                <div class="w-8 h-8 bg-gray-300 rounded-full flex-shrink-0 flex items-center justify-center text-gray-600 font-bold">
                    U
                </div>
            `;
            
            document.getElementById('messagesList').appendChild(messageDiv);
            scrollToBottom();
        }

        function addBotMessage(message, imageUrl = '') {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message flex gap-3';
            
            // Format the message (preserve line breaks, bold text)
            const formattedMessage = formatMessage(message);
            
            // Use different avatar for AI mode
            const avatar = isAIMode ? 'ü§ñ' : 'AI';
            
            // Generate unique ID for this message
            const messageId = 'msg-' + Date.now();
            
            // Create image HTML if imageUrl is provided
            const imageHTML = imageUrl && imageUrl.trim() !== '' ? `
                <div class="mt-3">
                    <img 
                        src="${imageUrl}" 
                        alt="Reference image" 
                        class="max-w-full rounded-lg shadow-md border border-gray-200 cursor-pointer hover:shadow-lg transition"
                        onclick="window.open('${imageUrl}', '_blank')"
                        onerror="this.parentElement.style.display='none'"
                        style="max-height: 400px; object-fit: contain;"
                    />
                </div>
            ` : '';
            
            messageDiv.innerHTML = `
                <div class="w-8 h-8 bg-purple-600 rounded-full flex-shrink-0 flex items-center justify-center text-white font-bold">
                    ${avatar}
                </div>
                <div class="flex-1">
                    <div class="bg-white rounded-2xl rounded-tl-none px-4 py-3 shadow-sm">
                        <div class="flex items-start gap-2">
                            <div class="flex-1 text-gray-800 whitespace-pre-wrap">${formattedMessage}</div>
                            <button 
                                onclick="speakMessage('${messageId}')" 
                                class="voice-btn flex-shrink-0 p-2 rounded-lg hover:bg-purple-100 transition"
                                title="Listen to response"
                                id="speaker-${messageId}"
                            >
                                <svg class="speaker-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"/>
                                </svg>
                            </button>
                        </div>
                        ${imageHTML}
                    </div>
                </div>
            `;
            
            // Store the message text for TTS
            messageDiv.dataset.messageId = messageId;
            messageDiv.dataset.messageText = message;
            
            document.getElementById('messagesList').appendChild(messageDiv);
            scrollToBottom();
        }

        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typingIndicator';
            typingDiv.className = 'message flex gap-3';
            typingDiv.innerHTML = `
                <div class="w-8 h-8 bg-purple-600 rounded-full flex-shrink-0 flex items-center justify-center text-white font-bold">
                    AI
                </div>
                <div class="flex-1">
                    <div class="typing-indicator">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            `;
            
            document.getElementById('messagesList').appendChild(typingDiv);
            scrollToBottom();
        }

        function removeTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) indicator.remove();
        }

        function scrollToBottom() {
            const container = document.getElementById('messagesContainer');
            setTimeout(() => {
                container.scrollTop = container.scrollHeight;
            }, 100);
        }

        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                handleSendMessage(event);
            }
        }

        function resetChat() {
            // Clear AI conversation history
            aiConversationHistory = [];
            
            // Update welcome message based on mode
            const welcomeText = isAIMode 
                ? "Hi! üëã I'm your AI-powered SKSU assistant. Ask me anything about Sultan Kudarat State University!" 
                : "Hi! üëã I'm your SKSU SBO assistant. I can help you with information about:";
            
            document.getElementById('messagesList').innerHTML = `
                <div class="message flex gap-3">
                    <div class="w-8 h-8 bg-purple-600 rounded-full flex-shrink-0 flex items-center justify-center text-white font-bold">
                        ${isAIMode ? 'ü§ñ' : 'AI'}
                    </div>
                    <div class="flex-1">
                        <div class="bg-white rounded-2xl rounded-tl-none px-4 py-3 shadow-sm">
                            <p class="text-gray-800">${welcomeText}</p>
                        </div>
                        <div id="categorySuggestions" class="mt-3 flex flex-wrap gap-2">
                        </div>
                    </div>
                </div>
            `;
            
            // Only show category suggestions in FAQ mode
            if (!isAIMode) {
                displayCategorySuggestions();
            }
            
            scrollToBottom();
        }

        function formatMessage(message) {
            // Escape HTML
            let formatted = escapeHtml(message);
            
            // Convert **bold** to <strong>
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong class="font-semibold">$1</strong>');
            
            return formatted;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Open admin panel
        function openAdminPanel() {
            window.open('/admin.html', '_blank');
        }

        // ==================== VOICE FEATURES ====================

        // Toggle voice input (Speech-to-Text)
        function toggleVoiceInput() {
            if (!recognition) {
                alert('Speech recognition is not supported in your browser. Please use Chrome, Edge, or Safari.');
                return;
            }

            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }

        function startRecording() {
            try {
                recognition.start();
                isRecording = true;
                
                const voiceButton = document.getElementById('voiceButton');
                const micIcon = document.getElementById('micIcon');
                const inputHint = document.getElementById('inputHint');
                
                voiceButton.classList.add('recording');
                inputHint.textContent = 'üî¥ Listening... Speak now!';
                
                console.log('üé§ Recording started...');
            } catch (error) {
                console.error('Error starting recording:', error);
                stopRecording();
            }
        }

        function stopRecording() {
            if (recognition && isRecording) {
                recognition.stop();
            }
            
            isRecording = false;
            
            const voiceButton = document.getElementById('voiceButton');
            const inputHint = document.getElementById('inputHint');
            
            voiceButton.classList.remove('recording');
            inputHint.textContent = 'Press Enter to send, Shift+Enter for new line ‚Ä¢ Click üé§ for voice input';
            
            console.log('üé§ Recording stopped');
        }

        // Speak message (Text-to-Speech)
        function speakMessage(messageId) {
            // Stop any ongoing speech
            if (currentUtterance) {
                synthesis.cancel();
                // Reset all speaker buttons
                document.querySelectorAll('[id^="speaker-"]').forEach(btn => {
                    btn.classList.remove('speaking');
                    btn.innerHTML = `
                        <svg class="speaker-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"/>
                        </svg>
                    `;
                });
                currentUtterance = null;
                return;
            }

            // Find the message element
            const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
            if (!messageElement) return;

            const messageText = messageElement.dataset.messageText;
            if (!messageText) return;

            // Create speech utterance
            currentUtterance = new SpeechSynthesisUtterance(messageText);
            
            // Apply voice settings from database
            console.log('üéôÔ∏è Applying voice settings:', voiceSettings);
            console.log('üì¢ Available voices:', availableVoices.length);
            
            if (voiceSettings) {
                currentUtterance.lang = voiceSettings.voice_lang || 'en-US';
                currentUtterance.rate = voiceSettings.voice_rate || 1.0;
                currentUtterance.pitch = voiceSettings.voice_pitch || 1.0;
                currentUtterance.volume = voiceSettings.voice_volume || 1.0;
                
                console.log(`‚úÖ Settings applied - Rate: ${currentUtterance.rate}, Pitch: ${currentUtterance.pitch}, Volume: ${currentUtterance.volume}, Lang: ${currentUtterance.lang}`);
                
                // Set specific voice if configured
                if (voiceSettings.voice_name && availableVoices.length > 0) {
                    const selectedVoice = availableVoices.find(voice => voice.name === voiceSettings.voice_name);
                    if (selectedVoice) {
                        currentUtterance.voice = selectedVoice;
                        console.log(`üó£Ô∏è Voice set to: ${selectedVoice.name}`);
                    } else {
                        console.warn(`‚ö†Ô∏è Voice "${voiceSettings.voice_name}" not found in available voices`);
                    }
                } else if (!voiceSettings.voice_name) {
                    console.log('‚ÑπÔ∏è No specific voice configured, using browser default');
                }
            } else {
                // Fallback to defaults
                console.warn('‚ö†Ô∏è No voice settings loaded, using defaults');
                currentUtterance.lang = 'en-US';
                currentUtterance.rate = 1.0;
                currentUtterance.pitch = 1.0;
                currentUtterance.volume = 1.0;
            }

            const speakerButton = document.getElementById('speaker-' + messageId);

            // Update button to show playing state
            speakerButton.classList.add('speaking');
            speakerButton.innerHTML = `
                <svg class="speaker-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10h.01M15 10h.01"/>
                </svg>
            `;

            // Handle speech end
            currentUtterance.onend = () => {
                speakerButton.classList.remove('speaking');
                speakerButton.innerHTML = `
                    <svg class="speaker-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"/>
                    </svg>
                `;
                currentUtterance = null;
            };

            // Handle errors
            currentUtterance.onerror = (event) => {
                console.error('Speech synthesis error:', event);
                speakerButton.classList.remove('speaking');
                currentUtterance = null;
            };

            // Start speaking
            synthesis.speak(currentUtterance);
            console.log('üîä Speaking:', messageText.substring(0, 50) + '...');
        }

        // Stop all speech when page unloads
        window.addEventListener('beforeunload', () => {
            if (synthesis) {
                synthesis.cancel();
            }
        });
    </script>
</body>
</html>
