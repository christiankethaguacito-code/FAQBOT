<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Settings Debug Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-lg p-6">
        <h1 class="text-3xl font-bold mb-6 text-purple-600">üîç Voice Settings Debug Tool</h1>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <button onclick="checkSettings()" class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600">
                1Ô∏è‚É£ Check Database Settings
            </button>
            
            <button onclick="testVoice()" class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600">
                2Ô∏è‚É£ Test Voice with Current Settings
            </button>
            
            <button onclick="updateSettings()" class="bg-orange-500 text-white px-6 py-3 rounded-lg hover:bg-orange-600">
                3Ô∏è‚É£ Update Settings (Test)
            </button>
            
            <button onclick="reloadPage()" class="bg-purple-500 text-white px-6 py-3 rounded-lg hover:bg-purple-600">
                4Ô∏è‚É£ Reload Main Page
            </button>
        </div>
        
        <div id="output" class="bg-gray-50 rounded-lg p-4 border border-gray-200">
            <h3 class="font-bold mb-2">Console Output:</h3>
            <pre id="result" class="text-sm overflow-auto">Click a button to test...</pre>
        </div>
        
        <div class="mt-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
            <h3 class="font-bold text-blue-800 mb-2">üìù Instructions:</h3>
            <ol class="list-decimal list-inside text-sm text-blue-700 space-y-1">
                <li>First, set voice settings in the admin panel</li>
                <li>Click "Check Database Settings" to see if they were saved</li>
                <li>Click "Test Voice" to hear the settings in action</li>
                <li>Open browser console (F12) to see detailed logs</li>
                <li>If settings are not applying, check the console for errors</li>
            </ol>
        </div>
    </div>

    <script>
        let currentSettings = null;
        let availableVoices = [];
        
        // Load voices
        function loadVoices() {
            availableVoices = speechSynthesis.getVoices();
            if (availableVoices.length === 0) {
                speechSynthesis.onvoiceschanged = () => {
                    availableVoices = speechSynthesis.getVoices();
                    console.log('üó£Ô∏è Voices loaded:', availableVoices.length);
                };
            }
        }
        loadVoices();
        
        function log(message) {
            console.log(message);
            const result = document.getElementById('result');
            result.textContent += message + '\n\n';
            result.scrollTop = result.scrollHeight;
        }
        
        async function checkSettings() {
            document.getElementById('result').textContent = '';
            log('üîç Checking voice settings from database...\n');
            
            try {
                const response = await fetch('/api/voice-settings');
                log(`üì° Response status: ${response.status}`);
                
                const data = await response.json();
                currentSettings = data.settings;
                
                log('‚úÖ Settings retrieved:\n' + JSON.stringify(data, null, 2));
                
                if (currentSettings) {
                    log('\nüìä Current Settings:');
                    log(`  Voice Name: ${currentSettings.voice_name || '(default)'}`);
                    log(`  Language: ${currentSettings.voice_lang}`);
                    log(`  Rate: ${currentSettings.voice_rate}x`);
                    log(`  Pitch: ${currentSettings.voice_pitch}`);
                    log(`  Volume: ${currentSettings.voice_volume}`);
                }
            } catch (error) {
                log('‚ùå Error: ' + error.message);
            }
        }
        
        async function testVoice() {
            if (!currentSettings) {
                await checkSettings();
            }
            
            log('\nüîä Testing voice with current settings...');
            
            const text = 'Hello! This is a test of the voice settings. Rate is ' + 
                        (currentSettings?.voice_rate || 1.0) + ', pitch is ' + 
                        (currentSettings?.voice_pitch || 1.0);
            
            const utterance = new SpeechSynthesisUtterance(text);
            
            if (currentSettings) {
                utterance.lang = currentSettings.voice_lang || 'en-US';
                utterance.rate = currentSettings.voice_rate || 1.0;
                utterance.pitch = currentSettings.voice_pitch || 1.0;
                utterance.volume = currentSettings.voice_volume || 1.0;
                
                log(`  Applied: Rate=${utterance.rate}, Pitch=${utterance.pitch}, Volume=${utterance.volume}`);
                
                if (currentSettings.voice_name) {
                    const selectedVoice = availableVoices.find(v => v.name === currentSettings.voice_name);
                    if (selectedVoice) {
                        utterance.voice = selectedVoice;
                        log(`  Voice: ${selectedVoice.name}`);
                    } else {
                        log(`  ‚ö†Ô∏è Voice "${currentSettings.voice_name}" not found`);
                    }
                }
            }
            
            speechSynthesis.speak(utterance);
            log('‚úÖ Speaking...');
        }
        
        async function updateSettings() {
            log('\nüíæ Updating settings to test values...');
            
            const testSettings = {
                voiceName: 'Google US English',
                voiceLang: 'en-US',
                voiceRate: 1.5,
                voicePitch: 1.2,
                voiceVolume: 0.8
            };
            
            log('Sending: ' + JSON.stringify(testSettings, null, 2));
            
            try {
                const response = await fetch('/api/admin/voice-settings', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testSettings)
                });
                
                const data = await response.json();
                log('\n‚úÖ Update response:\n' + JSON.stringify(data, null, 2));
                
                // Reload settings
                await checkSettings();
            } catch (error) {
                log('‚ùå Error: ' + error.message);
            }
        }
        
        function reloadPage() {
            window.open('http://localhost:3000', '_blank');
        }
    </script>
</body>
</html>
